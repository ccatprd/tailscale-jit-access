{% extends "base.html" %}

{% block title %}User Activity - JIT Access Management{% endblock %}

{% block content %}
<div style="display:flex; align-items:baseline; justify-content:space-between; flex-wrap:wrap; gap:8px; margin-bottom:12px;">
    <h2 style="margin:0;">User Activity Log</h2>
    <span style="color:#888; font-size:13px;">
        {{ total_entries }} total event{% if total_entries != 1 %}s{% endif %}
        {% if retention_days > 0 %}&nbsp;&middot;&nbsp;retained {{ retention_days }} days{% else %}&nbsp;&middot;&nbsp;retained indefinitely{% endif %}
        &nbsp;&middot;&nbsp;times in your local timezone
        <span class="info-tip" style="position:relative; display:inline-flex; align-items:center; margin-left:4px;">
            <span class="info-icon" tabindex="0" style="display:inline-flex; align-items:center; justify-content:center; width:14px; height:14px; border-radius:50%; border:1px solid #bbb; color:#bbb; font-size:10px; font-style:normal; font-weight:700; line-height:1; cursor:default; user-select:none;">i</span>
            <span class="info-bubble" style="display:none; position:absolute; right:0; top:20px; width:260px; background:#333; color:#fff; font-size:12px; line-height:1.5; padding:10px 12px; border-radius:6px; z-index:100; white-space:normal; font-weight:400; box-shadow:0 2px 8px rgba(0,0,0,.25);">
                Activity is logged once per session. A new session starts when you first visit after clearing cookies or after your session expires. Browsing within an existing session is not logged here. Specific actions (approvals, requests, revocations) are tracked in the <strong style="color:#fff;">Audit Log</strong>.
            </span>
        </span>
    </span>
</div>
<style>
.info-tip:hover .info-bubble,
.info-tip:focus-within .info-bubble { display:block !important; }
.info-icon:hover, .info-icon:focus { border-color:#888; color:#888; outline:none; }
</style>

{# Search bar #}
<form method="get" action="/activity" style="display:flex; gap:8px; margin-bottom:16px;">
    <input type="hidden" name="per_page" value="{{ page_size }}">
    <input
        type="search"
        name="q"
        value="{{ q }}"
        placeholder="Search by user, action, IP, session&hellip;"
        style="flex:1; padding:7px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px; outline:none;"
        autocomplete="off"
    >
    <button type="submit" style="padding:7px 16px; background:#5c6bc0; color:#fff; border:none; border-radius:6px; font-size:14px; cursor:pointer;">Search</button>
    {% if q %}
    <a href="/activity?per_page={{ page_size }}" style="padding:7px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px; text-decoration:none; color:#555; line-height:1.4;">Clear</a>
    {% endif %}
</form>

{% if q %}
<p style="color:#888; font-size:13px; margin:-8px 0 12px;">
    {{ total_entries }} result{% if total_entries != 1 %}s{% endif %} for &ldquo;{{ q }}&rdquo;
</p>
{% endif %}

{% if activity_entries %}
<table>
    <thead>
        <tr>
            <th>Timestamp</th>
            <th>User</th>
            <th>Action</th>
            <th>IP Address</th>
            <th>User Agent</th>
            <th>Session ID</th>
        </tr>
    </thead>
    <tbody>
        {% for entry in activity_entries %}
        <tr>
            <td class="ts" data-raw="{{ entry.timestamp }}" style="white-space:nowrap; font-size:13px;">{{ entry.timestamp }}</td>
            <td>{{ entry.user }}</td>
            <td>
                {% if entry.action == 'login' %}
                    <span style="color:#4CAF50;">&#10003; Login</span>
                {% else %}
                    {{ entry.action }}
                {% endif %}
            </td>
            <td style="font-size:13px;">{{ entry.ip_address }}</td>
            <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; font-size:13px;">{{ entry.user_agent }}</td>
            <td><code style="font-size:11px;">{{ entry.session_id }}</code></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{# Pagination + per-page selector #}
<div style="display:flex; align-items:center; justify-content:space-between; margin-top:20px; flex-wrap:wrap; gap:12px;">

    {# Page navigation #}
    <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
        {% if total_pages > 1 %}
            {% if page > 1 %}
                <a href="?page=1&per_page={{ page_size }}{% if q %}&q={{ q | urlencode }}{% endif %}" style="padding:5px 10px; border:1px solid #ddd; border-radius:4px; text-decoration:none; color:#333; font-size:13px;">&laquo; First</a>
                <a href="?page={{ page - 1 }}&per_page={{ page_size }}{% if q %}&q={{ q | urlencode }}{% endif %}" style="padding:5px 10px; border:1px solid #ddd; border-radius:4px; text-decoration:none; color:#333; font-size:13px;">&lsaquo; Prev</a>
            {% endif %}

            {% set win_start = [1, page - 3] | max %}
            {% set win_end   = [total_pages, page + 3] | min %}
            {% if win_start > 1 %}<span style="padding:5px 4px; color:#aaa; font-size:13px;">&hellip;</span>{% endif %}
            {% for p in range(win_start, win_end + 1) %}
                {% if p == page %}
                    <span style="padding:5px 10px; border:1px solid #5c6bc0; border-radius:4px; background:#5c6bc0; color:#fff; font-size:13px; font-weight:600;">{{ p }}</span>
                {% else %}
                    <a href="?page={{ p }}&per_page={{ page_size }}{% if q %}&q={{ q | urlencode }}{% endif %}" style="padding:5px 10px; border:1px solid #ddd; border-radius:4px; text-decoration:none; color:#333; font-size:13px;">{{ p }}</a>
                {% endif %}
            {% endfor %}
            {% if win_end < total_pages %}<span style="padding:5px 4px; color:#aaa; font-size:13px;">&hellip;</span>{% endif %}

            {% if page < total_pages %}
                <a href="?page={{ page + 1 }}&per_page={{ page_size }}{% if q %}&q={{ q | urlencode }}{% endif %}" style="padding:5px 10px; border:1px solid #ddd; border-radius:4px; text-decoration:none; color:#333; font-size:13px;">Next &rsaquo;</a>
                <a href="?page={{ total_pages }}&per_page={{ page_size }}{% if q %}&q={{ q | urlencode }}{% endif %}" style="padding:5px 10px; border:1px solid #ddd; border-radius:4px; text-decoration:none; color:#333; font-size:13px;">Last &raquo;</a>
            {% endif %}

            <span style="color:#999; font-size:12px; margin-left:4px;">Page {{ page }} of {{ total_pages }}</span>
        {% endif %}
    </div>

    {# Per-page selector #}
    <form method="get" action="/activity" style="display:flex; align-items:center; gap:6px;">
        <input type="hidden" name="page" value="1">
        {% if q %}<input type="hidden" name="q" value="{{ q }}">{% endif %}
        <label for="per_page_select" style="font-size:13px; color:#888;">Rows per page:</label>
        <select id="per_page_select" name="per_page" onchange="this.form.submit()"
            style="padding:4px 8px; border:1px solid #ddd; border-radius:4px; font-size:13px; cursor:pointer;">
            {% for n in valid_per_page %}
                <option value="{{ n }}"{% if n == page_size %} selected{% endif %}>{{ n }}</option>
            {% endfor %}
        </select>
    </form>

</div>

{% else %}
<div style="text-align:center; padding:60px 20px; color:#666;">
    {% if q %}
        <p style="font-size:18px; font-weight:500; margin:0;">No results for &ldquo;{{ q }}&rdquo;</p>
        <a href="/activity" style="display:inline-block; margin-top:12px; font-size:14px; color:#5c6bc0;">Clear search</a>
    {% else %}
        <p style="font-size:18px; font-weight:500; margin:0;">No activity recorded</p>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('td.ts[data-raw]').forEach(cell => {
    cell.textContent = formatUTC(cell.dataset.raw);
});
</script>
{% endblock %}
