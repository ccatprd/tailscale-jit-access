# =============================================================================
# Tailscale JIT Access Management: Docker Compose
# =============================================================================
# Usage:
#   1. Copy .env.example to .env and fill in your values
#   2. docker compose up -d
#   3. Configure Tailscale Serve on the HOST:
#      tailscale serve --bg --accept-app-caps=yourdomain.com/cap/jit-access http://127.0.0.1:5000
# =============================================================================

services:
  jit-access:
    build: .
    container_name: tailscale-jit-access
    restart: unless-stopped
    ports:
      - "127.0.0.1:5000:5000"    # Only bind to localhost: Tailscale Serve handles external access
    env_file:
      - .env
    environment:
      - DB_PATH=/app/data/jit_access.db
    volumes:
      - jit-data:/app/data        # Persist SQLite database
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/healthz')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  jit-data:
    driver: local
