# Quick Start Guide - Tailscale JIT Access

This guide gets you up and running in 15 minutes.

**Prerequisites:**
- Ubuntu 22.04+ (or similar Linux)
- Tailscale installed and authenticated
- Admin access to your Tailscale tailnet
- Domain name for custom capability (can be any domain you own)

## Step 1: Create OAuth Client (3 minutes)

1. Go to https://login.tailscale.com/admin/settings/oauth
2. Click "Generate OAuth client"
3. Name: `JIT Access Manager`
4. Scopes: `devices:read`, `devices:write`
5. Save credentials (you'll need them in Step 3)

## Step 2: Install Application (5 minutes)

**Option A: Automated setup (recommended)**

```bash
git clone https://github.com/ccatprd/tailscale-jit-access.git
cd tailscale-jit-access
sudo bash deploy/setup.sh
```

This installs everything under `/opt/tailscale-jit-access/` with a dedicated service user.

**Option B: Manual setup**

```bash
git clone https://github.com/ccatprd/tailscale-jit-access.git
cd tailscale-jit-access
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
cp .env.example .env
```

## Step 3: Configure Environment (2 minutes)

**Option A (automated):** edit `/opt/tailscale-jit-access/.env` - `setup.sh` already created it with a generated `FLASK_SECRET_KEY`.

**Option B (manual):** create `.env` from the template first:
```bash
cp .env.example .env
```

Fill in these four values (all are required):

```bash
TAILSCALE_CLIENT_ID=paste-your-client-id
TAILSCALE_CLIENT_SECRET=paste-your-secret-key
TAILSCALE_TAILNET=your-tailnet.ts.net
CAP_DOMAIN=yourdomain.com/cap/jit-access
```

`FLASK_SECRET_KEY` is auto-generated by `setup.sh`. For manual installs, generate one with:
```bash
python3 -c "import secrets; print(secrets.token_hex(32))"
```

See `.env.example` for optional settings (access profiles, audit retention, expiry interval, etc.).

## Step 4: Update ACL (3 minutes)

Add to your Tailscale ACL (replace `yourdomain.com` and `your-email@example.com`):

```json
{
  "grants": [
    {
      "src": ["your-email@example.com"],
      "dst": ["tag:jit-access-app"],
      "app": {
        "yourdomain.com/cap/jit-access": [
          {
            "can_request_access": true,
            "can_approve_requests": true,
            "can_view_current_access": true,
            "can_view_audit": true,
            "can_view_debug": true,
            "can_admin_config": true
          }
        ]
      }
    }
  ],
  "tagOwners": {
    "tag:jit-access-app": ["your-email@example.com"]
  }
}
```

**Important:** The server must carry the `tag:jit-access-app` tag. Two options:
- **Via auth key (recommended):** Create an auth key at [tailscale.com/admin/settings/keys](https://tailscale.com/admin/settings/keys) with `tag:jit-access-app` set, then run:
  ```bash
  sudo tailscale up --auth-key=<your-tagged-auth-key>
  ```
- **Via Admin UI:** Go to [tailscale.com/admin/machines](https://tailscale.com/admin/machines), find your server, click the three-dot menu, select **Edit tags**, and add `tag:jit-access-app`.

## Step 5: Start Application (2 minutes)

**With systemd (recommended):**

Before starting, edit the Tailscale Serve service to set your capability domain:
```bash
sudo nano /etc/systemd/system/tailscale-serve.service
# Replace yourdomain.com/cap/jit-access with your actual CAP_DOMAIN value
```

Then start both services:
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now jit-access
sudo systemctl enable --now tailscale-serve
```

**Manual start (development only):**

```bash
# Start the app
source venv/bin/activate
python3 app.py

# In a separate terminal: start Tailscale Serve (replace yourdomain.com)
# This is what tailscale-serve.service does automatically in production
tailscale serve --bg --accept-app-caps=yourdomain.com/cap/jit-access http://127.0.0.1:5000
```

## Step 6: Access Application

Open browser and go to:
```
https://your-vm-hostname.your-tailnet.ts.net/
```

You should see the JIT Access Management interface!

## Next Steps

1. **Verify identity injection**: Go to Debug tab, check that `Tailscale-App-Capabilities` contains your permission JSON
2. **Test it**: Submit an access request (pick one of your devices and an access level), then approve it
3. **Add users**: Update ACL to grant `can_request_access` to other users
4. **Configure access profiles**: Set the `ACCESS_PROFILES` environment variable (see `.env.example`)
5. **Add posture checks**: Update ACL to use posture attributes for resource access
6. **Set up backups**: Add a cron job to run `sqlite3 /opt/tailscale-jit-access/jit_access.db ".backup 'backup-$(date +%Y%m%d).db'"`

## Troubleshooting

**Can't access the app?**
```bash
# Check the service is running
sudo systemctl status jit-access

# Check Tailscale Serve
tailscale serve status

# Check logs
sudo journalctl -u jit-access -f
```

**Permissions not working?**
- Check `/debug` page to see what capabilities are received
- If `Tailscale-App-Capabilities` is empty: verify `--accept-app-caps` in `tailscale-serve.service` matches your ACL capability string exactly
- Confirm `tailscale serve status` shows the proxy is active
- Ensure your device has the `tag:jit-access-app` tag
- ACL changes can take up to 60 seconds to propagate

**Devices not loading?**
- Verify OAuth client has `devices:read` scope
- Check logs: `sudo journalctl -u jit-access -f`
- Test OAuth manually:
  ```bash
  curl -X POST https://api.tailscale.com/api/v2/oauth/token \
    -d "client_id=YOUR_ID&client_secret=YOUR_SECRET"
  ```

See README.md for complete documentation.
